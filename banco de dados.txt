-- ========================================
-- BANCO DE DADOS: init_store
-- ========================================
USE init_store;

-- 1. Tabela de Usuários
CREATE TABLE usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    senha VARCHAR(255) NOT NULL,
    criado_em DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 2. Tabela de Produtos
CREATE TABLE produtos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(150) NOT NULL,
    preco DECIMAL(10,2) NOT NULL,
    imagem_url VARCHAR(500),
    estoque INT NOT NULL DEFAULT 0,
    criado_em DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 3. Tabela de Pedidos
CREATE TABLE pedidos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    data_pedido DATETIME DEFAULT CURRENT_TIMESTAMP,
    total DECIMAL(10,2) NOT NULL,
    endereco TEXT NOT NULL,
    cidade VARCHAR(100) NOT NULL,
    cep VARCHAR(20) NOT NULL,
    forma_pagamento VARCHAR(50) NOT NULL,
    status ENUM('Pendente', 'Pago', 'Enviado', 'Entregue', 'Cancelado') DEFAULT 'Pendente',
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 4. Tabela de Itens do Pedido
CREATE TABLE itens_pedido (
    id INT AUTO_INCREMENT PRIMARY KEY,
    pedido_id INT NOT NULL,
    produto_id INT NOT NULL,
    quantidade INT NOT NULL,
    preco_unitario DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (pedido_id) REFERENCES pedidos(id) ON DELETE CASCADE,
    FOREIGN KEY (produto_id) REFERENCES produtos(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ========================================
-- DADOS DE EXEMPLO (para testar)
-- ========================================

-- Usuário de teste (senha: password)
INSERT INTO usuarios (nome, email, senha) VALUES
('João Silva', 'joao@exemplo.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi');

-- Produtos de exemplo
INSERT INTO produtos (nome, preco, imagem_url, estoque) VALUES
('Notebook Gamer RTX 4070', 5499.99, 'noteb.png', 10),
('Monitor 27" Curvo 200Hz', 1099.98, 'monitor1.png', 15),
('Teclado Mecânico RGB', 349.90, 'teclado.png', 25),
('Mouse Gamer 16000 DPI', 199.90, 'mouse.png', 30);

USE init_store;

-- 1. Tabela de Categorias
CREATE TABLE categorias (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL UNIQUE,
    slug VARCHAR(100) NOT NULL UNIQUE,
    descricao TEXT,
    criado_em DATETIME DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 2. Adiciona coluna categoria_id em produtos
ALTER TABLE produtos 
ADD COLUMN categoria_id INT NULL AFTER imagem_url,
ADD FOREIGN KEY (categoria_id) REFERENCES categorias(id) ON DELETE SET NULL;

-- 3. Dados de exemplo (categorias reais do seu site)
INSERT INTO categorias (nome, slug) VALUES
('Notebooks', 'notebooks'),
('Monitores', 'monitores'),
('Teclados', 'teclados'),
('Mouses', 'mouses'),
('Fonte', 'fonte'),
('Placa de Video', 'placa de video'),
('Placa Mãe', 'placa mãe'),
('Memoria Ram', 'memoria ram'),
('Ssd', 'ssd');

-- Associe os produtos existentes às categorias
UPDATE produtos SET categoria_id = 1 WHERE nome LIKE '%Notebook%';
UPDATE produtos SET categoria_id = 2 WHERE nome LIKE '%Monitor%';
UPDATE produtos SET categoria_id = 3 WHERE nome LIKE '%Teclado%';
UPDATE produtos SET categoria_id = 4 WHERE nome LIKE '%Mouse%';


SET SQL_SAFE_UPDATES = 0;
UPDATE categorias SET slug = REPLACE(LOWER(nome), ' ', '_');
SET SQL_SAFE_UPDATES = 1;